<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noel - C√¢y th√¥ng t·ª± quay + click hi·ªán ·∫£nh</title>
  <style>
    :root{
      --bg1:#050814;
      --bg2:#0a1436;
      --fg:#eaf2ff;
      --gold:#ffef9a;
      --glow:#7df9ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden;background:var(--bg1);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    canvas{position:fixed; inset:0}

    .top{
      position:fixed; top:16px; left:0; right:0;
      display:flex; justify-content:center; pointer-events:none;
      z-index:6;
      text-transform:uppercase;
      letter-spacing:2px;
      font-weight:950;
      color:rgba(255,239,154,.95);
      text-shadow:0 0 18px rgba(255,239,154,.25), 0 18px 40px rgba(0,0,0,.55);
    }
    .top span{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }

    .hud{
      position:fixed; left:16px; bottom:16px; z-index:7;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:rgba(234,242,255,.86);
      font-size:13px;
      user-select:none;
    }
    .btn{
      cursor:pointer;border:none;border-radius:999px;
      padding:10px 12px;color:var(--fg);font-weight:900;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      transition:transform .15s ease, opacity .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); opacity:1; }
    .tip{
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      max-width:min(560px, 92vw);
    }

    /* clickable hotspots layer (over canvas) */
    .hotspots{
      position:fixed; inset:0; z-index:8;
      pointer-events:auto;
    }
    .hotspot{
      position:absolute;
      width:46px; height:46px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:grid; place-items:center;
      cursor:pointer;
      transform: translate(-50%,-50%);
      transition: transform .15s ease, filter .15s ease;
      pointer-events:auto;
    }
    .hotspot:hover{
      transform: translate(-50%,-50%) scale(1.06);
      filter: drop-shadow(0 0 18px rgba(255,239,154,.28));
    }
    .hotspot svg{ width:28px; height:28px; }

    /* lightbox */
    .lightbox{
      position:fixed; inset:0;
      z-index:20;
      display:none;
      place-items:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .lightbox.show{ display:grid; }
    .viewer{
      width:min(520px, 92vw);
      aspect-ratio: 4/3;
      border-radius:18px;
      overflow:hidden;
      border:3px solid rgba(255,239,154,.75);
      box-shadow:0 40px 120px rgba(0,0,0,.6);
      background:#0b1230;
      position:relative;
    }
    .viewer img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .close{
      position:fixed; top:16px; right:16px; z-index:21;
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:var(--fg);
      font-weight:900;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .cap{
      position:absolute; left:12px; right:12px; bottom:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(234,242,255,.92);
      font-weight:900;
      text-shadow:0 10px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .cap small{display:block; font-weight:700; opacity:.8; margin-top:3px}
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div class="top"><span>MERRY CHRISTMAS</span></div>

  <div class="hud">
    <button class="btn" id="paletteBtn">üé® ƒê·ªïi m√†u</button>
    <button class="btn" id="speedBtn">üåÄ T·ªëc ƒë·ªô quay: 1x</button>
    <div class="tip">C√¢y th√¥ng t·ª± quay ‚Ä¢ Click <b>Chu√¥ng</b> ho·∫∑c <b>Qu√†</b> tr√™n c√¢y ƒë·ªÉ hi·ªán ·∫£nh c√†i s·∫µn ‚ú®</div>
  </div>

  <!-- Clickable overlays (positions are updated by JS every frame) -->
  <div class="hotspots" id="hotspots">
    <div class="hotspot" id="hsBell" title="Chu√¥ng Noel">
      <!-- bell icon -->
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 2c4 0 7 3 7 7v4c0 2 1 3 2 4H3c1-1 2-2 2-4V9c0-4 3-7 7-7Z" fill="rgba(255,209,102,.95)"/>
        <path d="M8 17h8c-.5 2-2.2 3.5-4 3.5S8.5 19 8 17Z" fill="rgba(255,239,154,.95)"/>
        <circle cx="12" cy="18" r="1.4" fill="rgba(10,20,54,.65)"/>
        <rect x="10" y="1" width="4" height="3" rx="1.5" fill="rgba(234,242,255,.85)"/>
      </svg>
    </div>

    <div class="hotspot" id="hsGift" title="M√≥n qu√†">
      <!-- gift icon -->
      <svg viewBox="0 0 24 24" fill="none">
        <rect x="4" y="9" width="16" height="12" rx="3" fill="rgba(255,77,109,.92)"/>
        <rect x="11" y="9" width="2" height="12" rx="1" fill="rgba(255,255,255,.55)"/>
        <rect x="4" y="14" width="16" height="2" rx="1" fill="rgba(255,255,255,.55)"/>
        <path d="M12 9c-2.3-1.3-4-2.7-3.2-4.2.8-1.6 3.2-1.1 4.2.7.7 1.2 1.1 2.2 1.2 3.5"
              fill="rgba(255,255,255,.55)"/>
        <path d="M12 9c2.3-1.3 4-2.7 3.2-4.2-.8-1.6-3.2-1.1-4.2.7-.7 1.2-1.1 2.2-1.2 3.5"
              fill="rgba(255,255,255,.55)"/>
      </svg>
    </div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <button class="close" id="closeBtn">‚úï</button>
    <div class="viewer">
      <img id="lbImg" alt="preset image" />
      <div class="cap" id="lbCap">·∫¢nh<div><small id="lbSub">M√¥ t·∫£</small></div></div>
    </div>
  </div>

<script>
(() => {
  // =============================
  // Preset images (embedded SVG)
  // =============================
  function svgData(svg){ return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg); }

  const PRESET = {
    bell: {
      title: "Chu√¥ng Noel",
      sub: "Jingle bells ‚ú®",
      src: svgData(`
        <svg xmlns="http://www.w3.org/2000/svg" width="900" height="675">
          <defs>
            <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
              <stop stop-color="#ffef9a" stop-opacity=".35"/>
              <stop offset="1" stop-color="#0a1436"/>
            </linearGradient>
            <radialGradient id="g" cx="35%" cy="25%" r="80%">
              <stop stop-color="#7df9ff" stop-opacity=".22"/>
              <stop offset="1" stop-color="rgba(0,0,0,0)"/>
            </radialGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#bg)"/>
          <circle cx="210" cy="140" r="260" fill="url(#g)"/>
          <text x="60" y="110" fill="#eaf2ff" font-family="Verdana" font-size="54" font-weight="800">Jingle Bell</text>
          <text x="60" y="168" fill="#eaf2ff" font-family="Verdana" font-size="26" opacity=".85">Ch√∫c b·∫°n m·ªôt m√πa Gi√°ng sinh an l√†nh!</text>

          <g transform="translate(450,170)">
            <path d="M0 0c120 0 216 96 216 216v120c0 78-60 144-144 156H-72c-84-12-144-78-144-156V216C-216 96-120 0 0 0z"
              fill="#ffd166"/>
            <path d="M-174 372h348c-18 54-66 90-120 90H-54c-54 0-102-36-120-90z"
              fill="#ffef9a" opacity=".95"/>
            <circle cx="0" cy="470" r="28" fill="#0a1436" opacity=".7"/>
            <rect x="-42" y="-48" width="84" height="56" rx="28" fill="#eaf2ff" opacity=".9"/>
            <path d="M-110 120c40-60 90-90 110-90s70 30 110 90" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="14" stroke-linecap="round"/>
          </g>
        </svg>
      `)
    },
    gift: {
      title: "M√≥n qu√†",
      sub: "Surprise time üéÅ",
      src: svgData(`
        <svg xmlns="http://www.w3.org/2000/svg" width="900" height="675">
          <defs>
            <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
              <stop stop-color="#ff4d6d" stop-opacity=".25"/>
              <stop offset="1" stop-color="#0a1436"/>
            </linearGradient>
            <radialGradient id="gl" cx="35%" cy="25%" r="80%">
              <stop stop-color="#ffef9a" stop-opacity=".22"/>
              <stop offset="1" stop-color="rgba(0,0,0,0)"/>
            </radialGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#bg)"/>
          <circle cx="220" cy="160" r="280" fill="url(#gl)"/>
          <text x="60" y="110" fill="#eaf2ff" font-family="Verdana" font-size="54" font-weight="800">Gift Box</text>
          <text x="60" y="168" fill="#eaf2ff" font-family="Verdana" font-size="26" opacity=".85">M·ªü qu√† ra l√† may m·∫Øn c·∫£ nƒÉm ‚ú®</text>

          <g transform="translate(450,220)">
            <rect x="-220" y="120" width="440" height="280" rx="44" fill="#ff4d6d"/>
            <rect x="-28" y="120" width="56" height="280" rx="18" fill="rgba(255,255,255,.55)"/>
            <rect x="-220" y="232" width="440" height="56" rx="20" fill="rgba(255,255,255,.55)"/>

            <path d="M-20 120c-60-30-110-70-92-110 18-42 86-30 122 24 22 32 34 58 38 86"
              fill="rgba(255,255,255,.55)"/>
            <path d="M20 120c60-30 110-70 92-110-18-42-86-30-122 24-22 32-34 58-38 86"
              fill="rgba(255,255,255,.55)"/>
            <circle cx="0" cy="120" r="28" fill="rgba(255,255,255,.65)"/>
          </g>
        </svg>
      `)
    }
  };

  // =============================
  // Canvas setup
  // =============================
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false });
  let W=0,H=0,DPR=1;

  function resize(){
    DPR = Math.min(2, devicePixelRatio || 1);
    canvas.width = Math.floor(innerWidth * DPR);
    canvas.height = Math.floor(innerHeight * DPR);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    W = innerWidth; H = innerHeight;
    initSnow();
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  const rand=(a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  // palettes
  const palettes = [
    {bg1:'#050814', bg2:'#0a1436', cols:['#ffef9a','#ffd166','#ff9f1c','#ff4d6d','#b388ff','#7df9ff','#a7ff83','#ffffff']},
    {bg1:'#02030a', bg2:'#071b2a', cols:['#ffffff','#00d1ff','#00ff87','#ffe66d','#c77dff','#ff4d6d','#7df9ff']},
    {bg1:'#050814', bg2:'#1a0a2a', cols:['#ff9bd3','#7df9ff','#ffd166','#ffffff','#4cc9f0','#b388ff']}
  ];
  let palIndex = 0;

  // rotation speed control
  let speedMul = 1;
  const speedBtn = document.getElementById('speedBtn');
  speedBtn.addEventListener('click', ()=>{
    speedMul = speedMul === 1 ? 1.8 : speedMul === 1.8 ? 0.6 : 1;
    speedBtn.textContent = `üåÄ T·ªëc ƒë·ªô quay: ${speedMul}x`;
  });
  document.getElementById('paletteBtn').addEventListener('click', ()=>{
    palIndex = (palIndex+1) % palettes.length;
    initAll();
  });

  // =============================
  // Snow
  // =============================
  const snow = [];
  function initSnow(){
    snow.length = 0;
    const n = Math.min(280, Math.floor(W/3));
    for(let i=0;i<n;i++){
      snow.push({x:rand(0,W), y:rand(0,H), r:rand(0.7,2.4), v:rand(0.6,2.2), s:rand(-0.6,0.6), w:rand(0,Math.PI*2)});
    }
  }

  // =============================
  // Fake 3D projection
  // =============================
  function project(x,y,z, rotY, rotX){
    const cy=Math.cos(rotY), sy=Math.sin(rotY);
    let xx = x*cy + z*sy;
    let zz = -x*sy + z*cy;

    const cx=Math.cos(rotX), sx=Math.sin(rotX);
    let yy = y*cx - zz*sx;
    zz = y*sx + zz*cx;

    const dist = 2.30;
    const p = dist / (dist + zz);
    return { x: xx*p, y: yy*p, p };
  }

  // =============================
  // Tree particles + decorations
  // =============================
  const tree = [];
  const ornaments = [];   // baubles
  const lights = [];      // blinking bulbs
  const garlands = [];    // garland seed points

  // clickable decorations (bell, gift) in 3D coords
  const decos = {
    bell: { nx: 0.12, ny: 0.28, nz: 0.08 },
    gift: { nx: -0.18, ny: 0.62, nz: -0.10 }
  };

  function initAll(){
    initSnow();
    initTree();
  }

  function initTree(){
    tree.length = 0;
    ornaments.length = 0;
    lights.length = 0;
    garlands.length = 0;

    const cols = palettes[palIndex].cols;
    const N_TREE = 2000;

    // TREE: t=0 top, t=1 bottom  ‚úÖ (kh√¥ng b·ªã ng∆∞·ª£c)
    for(let i=0;i<N_TREE;i++){
      const t = i/(N_TREE-1);
      const radius = (0.04 + 0.58*t) * (0.94 + 0.06*Math.sin(t*9.5));
      const turns = 15;
      const ang = t * Math.PI*2 * turns + rand(-0.35, 0.35);

      const nx = Math.cos(ang)*radius;
      const nz = Math.sin(ang)*radius;
      const ny = t;

      tree.push({
        nx,ny,nz,
        size: rand(0.6, 2.4),
        phase: rand(0, Math.PI*2),
        spd: rand(0.8, 2.1),
        c: cols[Math.floor(rand(0, cols.length))],
        tw: rand(0.35, 1.0)
      });
    }

    // baubles
    const ornamentColors = ['#ff4d6d','#ffd166','#4cc9f0','#a7ff83','#b388ff','#ffffff'];
    for(let i=0;i<18;i++){
      const t = rand(0.16, 0.92);
      const radius = 0.06 + 0.50*t;
      const ang = rand(0, Math.PI*2);
      ornaments.push({
        nx: Math.cos(ang)*radius,
        nz: Math.sin(ang)*radius,
        ny: t,
        r: rand(3.0, 6.8),
        c: ornamentColors[i % ornamentColors.length],
        phase: rand(0, Math.PI*2)
      });
    }

    // blinking lights distributed around garlands
    const bulbs = 42;
    for(let i=0;i<bulbs;i++){
      const t = rand(0.18, 0.94);
      const radius = 0.06 + 0.52*t;
      const ang = rand(0, Math.PI*2);
      lights.push({
        nx: Math.cos(ang)*radius,
        nz: Math.sin(ang)*radius,
        ny: t,
        r: rand(1.6, 2.8),
        c: cols[i % cols.length],
        phase: rand(0, Math.PI*2),
        spd: rand(2.0, 4.2)
      });
    }

    // garland seed arcs (for drawing lines)
    for(let k=0;k<4;k++){
      garlands.push({ ny: 0.18 + k*0.18, amp: 0.36 + k*0.08, phase: rand(0, Math.PI*2) });
    }
  }

  initAll();

  // =============================
  // Star
  // =============================
  function drawStar(x,y,R,r){
    ctx.beginPath();
    for(let i=0;i<10;i++){
      const a = -Math.PI/2 + i*(Math.PI/5);
      const rr = (i%2===0)?R:r;
      ctx.lineTo(x + Math.cos(a)*rr, y + Math.sin(a)*rr);
    }
    ctx.closePath(); ctx.fill();
  }

  // =============================
  // Hotspot positioning
  // =============================
  const hsBell = document.getElementById('hsBell');
  const hsGift = document.getElementById('hsGift');

  function setHotspot(el, x, y, visible){
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.display = visible ? "grid" : "none";
  }

  // =============================
  // Lightbox handlers
  // =============================
  const lightbox = document.getElementById('lightbox');
  const lbImg = document.getElementById('lbImg');
  const lbCap = document.getElementById('lbCap');
  const lbSub = document.getElementById('lbSub');

  function openPreset(key){
    const p = PRESET[key];
    lbImg.src = p.src;
    lbCap.childNodes[0].nodeValue = p.title;
    lbSub.textContent = p.sub;
    lightbox.classList.add('show');
    lightbox.setAttribute('aria-hidden', 'false');
  }
  function closePreset(){
    lightbox.classList.remove('show');
    lightbox.setAttribute('aria-hidden', 'true');
  }
  document.getElementById('closeBtn').addEventListener('click', closePreset);
  lightbox.addEventListener('click', (e)=>{ if(e.target === lightbox) closePreset(); });

  hsBell.addEventListener('click', ()=>openPreset('bell'));
  hsGift.addEventListener('click', ()=>openPreset('gift'));

  // =============================
  // Render loop
  // =============================
  let last = performance.now();
  let autoRot = 0;

  function frame(now){
    const dt = Math.min(40, now-last); last=now;
    const t = now*0.001;

    const pal = palettes[palIndex];

    // auto rotation (continuous)
    autoRot += (dt * 0.001) * 0.75 * speedMul;

    // background gradient
    const bg = ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0, pal.bg1);
    bg.addColorStop(1, pal.bg2);
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    // subtle trails (sparkle smear)
    ctx.fillStyle = "rgba(0,0,0,0.12)";
    ctx.fillRect(0,0,W,H);

    // snow
    ctx.globalAlpha = 0.92;
    for(const s of snow){
      s.w += 0.01 + s.r*0.002;
      s.y += s.v;
      s.x += s.s + Math.sin(s.w)*0.35;
      if(s.y > H+10){ s.y=-10; s.x=rand(0,W); }
      if(s.x < -10) s.x = W+10;
      if(s.x > W+10) s.x = -10;

      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // fixed camera tilt
    const rotY = autoRot;
    const rotX = -0.18;

    // center & scale
    const cx = W*0.5;
    const cy = H*0.56;
    const scale = Math.min(W,H)*0.55;

    // star at top
    const starY = cy - scale*0.60;
    ctx.globalCompositeOperation = "lighter";
    const rg = ctx.createRadialGradient(cx, starY, 0, cx, starY, scale*0.22);
    rg.addColorStop(0, "rgba(255,239,154,0.55)");
    rg.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = rg;
    ctx.beginPath(); ctx.arc(cx, starY, scale*0.22, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(255,239,154,0.95)";
    drawStar(cx, starY, scale*0.06, scale*0.026);

    // trunk
    ctx.globalCompositeOperation = "source-over";
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "rgba(100,60,44,0.9)";
    const tw = scale*0.10, th = scale*0.20;
    ctx.beginPath();
    ctx.roundRect(cx - tw/2, cy + scale*0.33, tw, th, scale*0.03);
    ctx.fill();
    ctx.globalAlpha = 1;

    // garlands (sparkly arcs)
    ctx.globalCompositeOperation = "lighter";
    ctx.lineWidth = 2;
    for(const g of garlands){
      const yy = cy + ((g.ny - 0.5) * 1.44) * scale;
      const ww = scale * g.amp;
      ctx.globalAlpha = 0.22 + 0.10*Math.sin(t*1.2 + g.phase);
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.beginPath();
      ctx.ellipse(cx, yy, ww, scale*0.10, 0, 0, Math.PI);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // tree particles
    for(const p of tree){
      const pulse = 0.55 + 0.45*Math.sin(t*2.1 + p.phase);
      const twi = p.tw*pulse;

      const wob = Math.sin(t*p.spd + p.phase) * 0.06;
      const tx = p.nx*(1+wob);
      const ty = (p.ny - 0.5) * 1.44;  // ‚úÖ top negative, bottom positive
      const tz = p.nz*(1+wob);

      const pr = project(tx,ty,tz, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const a = clamp((0.10 + twi)*pr.p, 0.06, 0.95);
      const r0 = (p.size*1.05) * (0.65 + pr.p);

      ctx.globalAlpha = a;
      ctx.fillStyle = p.c;
      ctx.beginPath(); ctx.arc(sx, sy, r0, 0, Math.PI*2); ctx.fill();

      ctx.globalAlpha = a*0.26;
      ctx.beginPath(); ctx.arc(sx, sy, r0*3.0, 0, Math.PI*2); ctx.fill();
    }

    // blinking lights
    for(const l of lights){
      const blink = 0.45 + 0.55*Math.sin(t*l.spd + l.phase);
      const x = l.nx, y = (l.ny - 0.5)*1.44, z = l.nz;
      const pr = project(x,y,z, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const a = clamp(0.20 + 0.60*blink, 0.12, 0.92) * pr.p;
      const r0 = l.r*(0.9 + pr.p*0.35);

      ctx.globalAlpha = a;
      ctx.fillStyle = l.c;
      ctx.beginPath(); ctx.arc(sx,sy,r0,0,Math.PI*2); ctx.fill();

      ctx.globalAlpha = a*0.35;
      ctx.beginPath(); ctx.arc(sx,sy,r0*4.2,0,Math.PI*2); ctx.fill();
    }

    // ornaments (baubles)
    for(const o of ornaments){
      const bob = Math.sin(t*2.2 + o.phase)*0.02;
      const x = o.nx*(1+bob);
      const y = (o.ny - 0.5) * 1.44;
      const z = o.nz*(1+bob);

      const pr = project(x,y,z, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const glow = 0.55 + 0.45*Math.sin(t*3.0 + o.phase);
      ctx.globalAlpha = 0.65*glow;

      ctx.fillStyle = o.c;
      ctx.beginPath(); ctx.arc(sx, sy, o.r*(0.75+pr.p*0.25), 0, Math.PI*2); ctx.fill();

      ctx.globalAlpha *= 0.45;
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.beginPath(); ctx.arc(sx - o.r*0.25, sy - o.r*0.25, o.r*0.35, 0, Math.PI*2); ctx.fill();

      ctx.globalAlpha *= 0.55;
      ctx.fillStyle = o.c;
      ctx.beginPath(); ctx.arc(sx, sy, o.r*2.2, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;

    // base glow
    ctx.globalAlpha = 0.55;
    const base = ctx.createRadialGradient(cx, cy+scale*0.58, 0, cx, cy+scale*0.58, scale*0.44);
    base.addColorStop(0, "rgba(125,249,255,0.10)");
    base.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = base;
    ctx.beginPath(); ctx.arc(cx, cy+scale*0.58, scale*0.44, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;

    ctx.globalCompositeOperation = "source-over";

    // =============================
    // Update clickable hotspots positions
    // (project their 3D coords to screen)
    // =============================
    // Bell
    {
      const d = decos.bell;
      const pr = project(d.nx, (d.ny - 0.5)*1.44, d.nz, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;
      // only show if it's in front-ish
      const visible = pr.p > 0.68;
      setHotspot(hsBell, sx, sy, visible);
    }
    // Gift
    {
      const d = decos.gift;
      const pr = project(d.nx, (d.ny - 0.5)*1.44, d.nz, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;
      const visible = pr.p > 0.68;
      setHotspot(hsGift, sx, sy, visible);
    }

    requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
