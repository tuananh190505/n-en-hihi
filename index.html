<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noel - Tree Ultra Effects + Halo Light</title>
  <style>
    :root{
      --bg1:#050814; --bg2:#0a1436; --fg:#eaf2ff;
      --gold:#ffef9a; --glow:#7df9ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden;background:var(--bg1);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    canvas{position:fixed;inset:0}

    .top{
      position:fixed; top:16px; left:0; right:0; z-index:6;
      display:flex; justify-content:center; pointer-events:none;
      text-transform:uppercase; letter-spacing:2px; font-weight:950;
      color:rgba(255,239,154,.95);
      text-shadow:0 0 18px rgba(255,239,154,.25), 0 18px 40px rgba(0,0,0,.55);
    }
    .top span{
      padding:10px 14px; border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }

    .toast{
      position:fixed; left:16px; bottom:16px; z-index:30;
      display:none;
      color:rgba(234,242,255,.92);
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      user-select:none;
    }
    .toast.show{display:block}

    .hotspots{position:fixed; inset:0; z-index:10; pointer-events:auto}
    .giftHotspot{
      position:absolute; width:56px; height:56px;
      transform:translate(-50%,-50%);
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:grid; place-items:center;
      cursor:pointer;
      transition:transform .15s ease, filter .15s ease, opacity .15s ease;
      opacity:.95;
    }
    .giftHotspot:hover{
      transform:translate(-50%,-50%) scale(1.07);
      filter: drop-shadow(0 0 18px rgba(255,239,154,.30));
      opacity:1;
    }
    .giftHotspot svg{width:34px;height:34px}

    .lightbox{
      position:fixed; inset:0; z-index:40;
      display:none; place-items:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .lightbox.show{display:grid}
    .viewer{
      width:min(820px, 94vw);
      height:min(560px, 78vh);
      border-radius:18px;
      overflow:hidden;
      border:3px solid rgba(255,239,154,.75);
      box-shadow:0 40px 120px rgba(0,0,0,.6);
      background:#0b1230;
      position:relative;
    }
    .viewer img{width:100%; height:100%; object-fit:contain; display:block; background:#0b1230}
    .cap{
      position:absolute; left:12px; right:12px; bottom:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(234,242,255,.92);
      font-weight:900;
      backdrop-filter: blur(10px);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .cap small{display:block; font-weight:700; opacity:.8; margin-top:3px}
    .controls{position:fixed; inset:0; z-index:41; pointer-events:none;}
    .btn{
      pointer-events:auto;
      position:fixed;
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:var(--fg);
      font-weight:900;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    #closeBtn{top:16px; right:16px}
    #prevBtn{left:16px; top:50%; transform:translateY(-50%)}
    #nextBtn{right:16px; top:50%; transform:translateY(-50%)}
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div class="top"><span>MERRY CHRISTMAS</span></div>

  <!-- autoplay loop music -->
  <audio id="bgm" src="assets/Last%20Christmas.mp3" autoplay loop playsinline></audio>
  <div class="toast" id="toast">üîä Tr√¨nh duy·ªát ch·∫∑n t·ª± ph√°t nh·∫°c. Ch·∫°m/click 1 l·∫ßn b·∫•t k·ª≥ ƒë·ªÉ b·∫≠t nh·∫°c.</div>

  <div class="hotspots" id="hotspots"></div>

  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="viewer">
      <img id="gimg" alt="gift image" />
      <div class="cap">
        <div>
          <div id="gtitle">Gift</div>
          <small id="gsub">·∫¢nh 1/1</small>
        </div>
        <div style="opacity:.9">üéÅ</div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="closeBtn">‚úï</button>
    <button class="btn" id="prevBtn">‚óÄ</button>
    <button class="btn" id="nextBtn">‚ñ∂</button>
  </div>

<script>
(() => {
  // ================================
  // 1) B·∫†N CH·ªàNH ·∫¢NH ·ªû ƒê√ÇY
  // ================================
  const GIFT_ALBUMS = {
    gift1: { title:"H·ªôp qu√† s·ªë 1", images:["assets/img1.jpg","assets/img2.jpg","assets/img3.jpg"] },
    gift2: { title:"H·ªôp qu√† s·ªë 2", images:["assets/img4.jpg","assets/img5.jpg"] },
    gift3: { title:"H·ªôp qu√† s·ªë 3", images:["assets/img6.jpg"] }
  };

  // ================================
  // 2) MUSIC AUTOPLAY (loop)
  // ================================
  const bgm = document.getElementById('bgm');
  const toast = document.getElementById('toast');
  async function tryPlay(){
    try{
      bgm.volume = 0.75;
      await bgm.play();
      toast.classList.remove('show');
    }catch(e){
      toast.classList.add('show');
      const unlock = async () => {
        try { await bgm.play(); toast.classList.remove('show'); } catch(_) {}
      };
      window.addEventListener('pointerdown', unlock, {once:true});
      window.addEventListener('keydown', unlock, {once:true});
    }
  }
  tryPlay();

  // ================================
  // 3) CANVAS
  // ================================
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false });
  let W=0,H=0,DPR=1;

  function resize(){
    DPR = Math.min(2, devicePixelRatio || 1);
    canvas.width = Math.floor(innerWidth * DPR);
    canvas.height = Math.floor(innerHeight * DPR);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    W = innerWidth; H = innerHeight;
    initSnow();
    initFireflies();
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  const rand=(a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  const palettes = [
    {bg1:'#050814', bg2:'#0a1436', cols:['#ffef9a','#ffd166','#ff9f1c','#ff4d6d','#b388ff','#7df9ff','#a7ff83','#ffffff']},
    {bg1:'#02030a', bg2:'#071b2a', cols:['#ffffff','#00d1ff','#00ff87','#ffe66d','#c77dff','#ff4d6d','#7df9ff']},
    {bg1:'#050814', bg2:'#1a0a2a', cols:['#ff9bd3','#7df9ff','#ffd166','#ffffff','#4cc9f0','#b388ff']}
  ];
  let palIndex = 0;

  // ================================
  // 4) EFFECTS: snow + fireflies + bursts
  // ================================
  const snow=[];
  function initSnow(){
    snow.length=0;
    const n = Math.min(360, Math.floor(W/2.6));
    for(let i=0;i<n;i++){
      snow.push({x:rand(0,W), y:rand(0,H), r:rand(0.7,2.6), v:rand(0.7,2.7), s:rand(-0.7,0.7), w:rand(0,Math.PI*2), a:rand(0.55,0.95)});
    }
  }

  // floating fireflies around tree for extra glow
  const fireflies=[];
  function initFireflies(){
    fireflies.length=0;
    const n = Math.min(90, Math.floor(W/14));
    for(let i=0;i<n;i++){
      fireflies.push({
        x: rand(W*0.25, W*0.75),
        y: rand(H*0.18, H*0.78),
        r: rand(0.8, 2.2),
        vx: rand(-0.25,0.25),
        vy: rand(-0.25,0.25),
        phase: rand(0, Math.PI*2)
      });
    }
  }

  const bursts=[];
  function spawnBurst(x,y,cols){
    for(let i=0;i<220;i++){
      bursts.push({x,y,vx:rand(-3.1,3.1),vy:rand(-3.1,3.1),life:rand(24,85),r:rand(1.1,3.6),c:cols[i%cols.length]});
    }
  }

  // ================================
  // 5) TREE (fake 3D) + halo light
  // ================================
  function project(x,y,z, rotY, rotX){
    const cy=Math.cos(rotY), sy=Math.sin(rotY);
    let xx = x*cy + z*sy;
    let zz = -x*sy + z*cy;

    const cx=Math.cos(rotX), sx=Math.sin(rotX);
    let yy = y*cx - zz*sx;
    zz = y*sx + zz*cx;

    const dist = 2.32;
    const p = dist / (dist + zz);
    return { x: xx*p, y: yy*p, p, zz };
  }
  function drawStar(x,y,R,r){
    ctx.beginPath();
    for(let i=0;i<10;i++){
      const a = -Math.PI/2 + i*(Math.PI/5);
      const rr = (i%2===0)?R:r;
      ctx.lineTo(x + Math.cos(a)*rr, y + Math.sin(a)*rr);
    }
    ctx.closePath(); ctx.fill();
  }

  const tree=[], ornaments=[], lights=[], garlands=[];
  const N_TREE = 2500;

  function initTree(){
    tree.length=0; ornaments.length=0; lights.length=0; garlands.length=0;
    const cols = palettes[palIndex].cols;

    // TREE: t=0 top, t=1 bottom (ƒë√∫ng chi·ªÅu)
    for(let i=0;i<N_TREE;i++){
      const t = i/(N_TREE-1);
      const radius = (0.035 + 0.62*t) * (0.94 + 0.06*Math.sin(t*10.8));
      const turns = 17;
      const ang = t * Math.PI*2 * turns + rand(-0.35, 0.35);

      tree.push({
        nx:Math.cos(ang)*radius,
        nz:Math.sin(ang)*radius,
        ny:t,
        size:rand(0.55,2.7),
        phase:rand(0,Math.PI*2),
        spd:rand(0.9,2.4),
        tw:rand(0.35,1.05),
        c: cols[Math.floor(rand(0, cols.length))]
      });
    }

    // ornaments
    const ornamentColors = ['#ff4d6d','#ffd166','#4cc9f0','#a7ff83','#b388ff','#ffffff'];
    for(let i=0;i<26;i++){
      const t = rand(0.12, 0.94);
      const radius = 0.06 + 0.54*t;
      const ang = rand(0, Math.PI*2);
      ornaments.push({nx:Math.cos(ang)*radius,nz:Math.sin(ang)*radius,ny:t,r:rand(3.0,7.4),c:ornamentColors[i%ornamentColors.length],phase:rand(0,Math.PI*2)});
    }

    // blinking lights
    for(let i=0;i<72;i++){
      const t = rand(0.14, 0.98);
      const radius = 0.06 + 0.56*t;
      const ang = rand(0, Math.PI*2);
      lights.push({nx:Math.cos(ang)*radius,nz:Math.sin(ang)*radius,ny:t,r:rand(1.5,3.2),c:cols[i%cols.length],phase:rand(0,Math.PI*2),spd:rand(2.4,5.0)});
    }

    // garlands
    for(let k=0;k<6;k++){
      garlands.push({ ny: 0.14 + k*0.14, amp: 0.34 + k*0.09, phase: rand(0,Math.PI*2) });
    }
  }
  initTree();

  // ================================
  // 6) Gifts + hotspots
  // ================================
  const hotspots = document.getElementById('hotspots');
  const giftHotspots = [
    { id:"gift1", x:-0.25, y:0.88, w:0.20, h:0.13, c:"#ff4d6d" },
    { id:"gift2", x: 0.00, y:0.90, w:0.18, h:0.12, c:"#4cc9f0" },
    { id:"gift3", x: 0.25, y:0.88, w:0.20, h:0.13, c:"#ffd166" },
    { id:"gift1", x:-0.10, y:0.86, w:0.14, h:0.10, c:"#b388ff" },
    { id:"gift2", x: 0.12, y:0.86, w:0.14, h:0.10, c:"#a7ff83" },
  ];

  function giftIconSVG(color){
    return `
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <rect x="4" y="9" width="16" height="12" rx="3" fill="${color}" opacity=".95"/>
        <rect x="11" y="9" width="2" height="12" rx="1" fill="rgba(255,255,255,.55)"/>
        <rect x="4" y="14" width="16" height="2" rx="1" fill="rgba(255,255,255,.55)"/>
        <path d="M12 9c-2.3-1.3-4-2.7-3.2-4.2.8-1.6 3.2-1.1 4.2.7.7 1.2 1.1 2.2 1.2 3.5"
              fill="rgba(255,255,255,.55)"/>
        <path d="M12 9c2.3-1.3 4-2.7 3.2-4.2-.8-1.6-3.2-1.1-4.2.7-.7 1.2-1.1 2.2-1.2 3.5"
              fill="rgba(255,255,255,.55)"/>
      </svg>`;
  }

  // create hotspot DOMs
  const hsEls = [];
  hotspots.innerHTML = "";
  for(let i=0;i<giftHotspots.length;i++){
    const g = giftHotspots[i];
    const el = document.createElement('div');
    el.className = 'giftHotspot';
    el.dataset.gift = g.id;
    el.dataset.idx = String(i);
    el.innerHTML = giftIconSVG(g.c);
    hotspots.appendChild(el);
    hsEls.push(el);
  }

  // ================================
  // 7) Lightbox
  // ================================
  const lightbox = document.getElementById('lightbox');
  const gimg = document.getElementById('gimg');
  const gtitle = document.getElementById('gtitle');
  const gsub = document.getElementById('gsub');
  const closeBtn = document.getElementById('closeBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  let currentGift = null;
  let currentIndex = 0;

  function openGift(giftId){
    const album = GIFT_ALBUMS[giftId];
    if(!album || !album.images || album.images.length===0){
      alert("B·∫°n ch∆∞a c·∫•u h√¨nh ·∫£nh cho " + giftId + " trong GIFT_ALBUMS.");
      return;
    }
    currentGift = giftId;
    currentIndex = 0;
    lightbox.classList.add('show');
    lightbox.setAttribute('aria-hidden','false');
    renderGallery();
  }
  function closeGift(){
    lightbox.classList.remove('show');
    lightbox.setAttribute('aria-hidden','true');
  }
  function renderGallery(){
    const album = GIFT_ALBUMS[currentGift];
    const total = album.images.length;
    currentIndex = (currentIndex + total) % total;
    gimg.src = album.images[currentIndex];
    gtitle.textContent = album.title || "Gift";
    gsub.textContent = `·∫¢nh ${currentIndex+1}/${total}`;
  }
  function prev(){ if(!currentGift) return; currentIndex--; renderGallery(); }
  function next(){ if(!currentGift) return; currentIndex++; renderGallery(); }

  closeBtn.addEventListener('click', closeGift);
  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);
  lightbox.addEventListener('click', (e)=>{ if(e.target===lightbox) closeGift(); });
  window.addEventListener('keydown', (e)=>{
    if(!lightbox.classList.contains('show')) return;
    if(e.key==='Escape') closeGift();
    if(e.key==='ArrowLeft') prev();
    if(e.key==='ArrowRight') next();
  });

  hotspots.addEventListener('click', (e)=>{
    const el = e.target.closest('.giftHotspot');
    if(!el) return;
    const giftId = el.dataset.gift;
    const rect = el.getBoundingClientRect();
    spawnBurst(rect.left + rect.width/2, rect.top + rect.height/2, palettes[palIndex].cols);
    openGift(giftId);
  });

  // ================================
  // 8) Helpers for drawing
  // ================================
  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // Gift boxes on canvas
  function drawGiftBox(centerX, baseY, scale, g, alpha){
    const x = centerX + g.x*scale;
    const y = baseY + g.y*scale;
    const ww = g.w*scale;
    const hh = g.h*scale;

    ctx.globalAlpha = alpha;
    ctx.fillStyle = g.c;
    roundRect(x-ww/2, y-hh/2, ww, hh, 16);
    ctx.fill();

    ctx.globalAlpha = alpha*0.70;
    ctx.fillStyle = "rgba(255,255,255,0.45)";
    ctx.fillRect(x-ww*0.07, y-hh/2, ww*0.14, hh);
    ctx.fillRect(x-ww/2, y-hh*0.07, ww, hh*0.14);

    // top bow glow
    ctx.globalCompositeOperation = "lighter";
    ctx.globalAlpha = alpha*0.22;
    ctx.fillStyle = g.c;
    ctx.beginPath();
    ctx.arc(x, y-hh*0.15, Math.max(ww,hh)*0.55, 0, Math.PI*2);
    ctx.fill();
    ctx.globalCompositeOperation = "source-over";
    ctx.globalAlpha = 1;
  }

  // ================================
  // 9) Render Loop
  // ================================
  let last = performance.now();
  let autoRot = 0;

  function frame(now){
    const dt = Math.min(40, now-last); last=now;
    const t = now*0.001;
    const pal = palettes[palIndex];

    // auto spin
    autoRot += (dt*0.001) * 0.85;

    // background gradient
    const bg = ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0, pal.bg1);
    bg.addColorStop(1, pal.bg2);
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    // neon clouds behind tree (more glow)
    ctx.globalCompositeOperation = "lighter";
    for(let i=0;i<4;i++){
      const rx = W*(0.18 + i*0.22) + Math.sin(t*0.35+i)*70;
      const ry = H*(0.22 + (i%2)*0.12);
      const rad = W*(0.26 + (i%2)*0.08);
      const gg = ctx.createRadialGradient(rx,ry,0,rx,ry,rad);
      gg.addColorStop(0, `rgba(125,249,255,${0.05 + 0.02*Math.sin(t+i)})`);
      gg.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = gg;
      ctx.beginPath(); ctx.arc(rx,ry,rad,0,Math.PI*2); ctx.fill();
    }
    ctx.globalCompositeOperation = "source-over";

    // soft trails for sparkle
    ctx.fillStyle = "rgba(0,0,0,0.11)";
    ctx.fillRect(0,0,W,H);

    // snow
    ctx.globalAlpha = 0.92;
    for(const s of snow){
      s.w += 0.01 + s.r*0.002;
      s.y += s.v;
      s.x += s.s + Math.sin(s.w)*0.35;
      if(s.y > H+10){ s.y=-10; s.x=rand(0,W); }
      if(s.x < -10) s.x = W+10;
      if(s.x > W+10) s.x = -10;
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${s.a})`;
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // fireflies (tiny glows around tree)
    ctx.globalCompositeOperation = "lighter";
    for(const f of fireflies){
      f.phase += 0.012;
      f.x += f.vx + Math.sin(f.phase)*0.12;
      f.y += f.vy + Math.cos(f.phase)*0.10;

      // keep near center zone
      const cx0 = W*0.5, cy0 = H*0.56;
      if(f.x < W*0.15 || f.x > W*0.85) f.vx *= -1;
      if(f.y < H*0.12 || f.y > H*0.86) f.vy *= -1;

      const a = 0.18 + 0.22*(0.5+0.5*Math.sin(f.phase*1.7));
      ctx.globalAlpha = a;
      ctx.fillStyle = pal.cols[(Math.floor(f.phase*10)) % pal.cols.length];
      ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = a*0.35;
      ctx.beginPath(); ctx.arc(f.x, f.y, f.r*5.5, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;
    ctx.globalCompositeOperation = "source-over";

    // camera
    const rotY = autoRot;
    const rotX = -0.18;
    const cx = W*0.5;
    const cy = H*0.56;
    const scale = Math.min(W,H)*0.55;

    // =========================
    // NEW: halo light around tree
    // =========================
    ctx.globalCompositeOperation = "lighter";

    // outer halo
    const haloR = scale*0.62;
    const halo = ctx.createRadialGradient(cx, cy, haloR*0.12, cx, cy, haloR);
    halo.addColorStop(0, "rgba(255,239,154,0.00)");
    halo.addColorStop(0.45, `rgba(125,249,255,${0.08 + 0.03*Math.sin(t*0.9)})`);
    halo.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = halo;
    ctx.beginPath(); ctx.arc(cx, cy, haloR, 0, Math.PI*2); ctx.fill();

    // rotating ring orbit (like light circle)
    ctx.globalAlpha = 0.55;
    ctx.lineWidth = 2;
    for(let k=0;k<2;k++){
      const rr = scale*(0.42 + k*0.13);
      ctx.strokeStyle = k===0 ? "rgba(255,239,154,0.35)" : "rgba(125,249,255,0.30)";
      ctx.beginPath();
      // ellipse orbit
      ctx.ellipse(cx, cy + scale*0.02, rr, rr*0.36, (t*0.55 + k)*0.9, 0, Math.PI*2);
      ctx.stroke();
    }

    // light rays
    ctx.globalAlpha = 0.10;
    for(let i=0;i<18;i++){
      const a = (i/18)*Math.PI*2 + t*0.20;
      const r1 = scale*0.12;
      const r2 = scale*0.90;
      ctx.strokeStyle = "rgba(255,239,154,0.18)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(cx + Math.cos(a)*r1, cy + Math.sin(a)*r1);
      ctx.lineTo(cx + Math.cos(a)*r2, cy + Math.sin(a)*r2);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // star glow
    const starY = cy - scale*0.62;
    const rg = ctx.createRadialGradient(cx, starY, 0, cx, starY, scale*0.26);
    rg.addColorStop(0, `rgba(255,239,154,${0.60 + 0.10*Math.sin(t*2)})`);
    rg.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = rg;
    ctx.beginPath(); ctx.arc(cx, starY, scale*0.26, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,239,154,0.97)";
    drawStar(cx, starY, scale*0.067, scale*0.029);

    ctx.globalCompositeOperation = "source-over";

    // trunk
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "rgba(100,60,44,0.9)";
    const tw = scale*0.10, th = scale*0.20;
    roundRect(cx - tw/2, cy + scale*0.33, tw, th, scale*0.03);
    ctx.fill();
    ctx.globalAlpha = 1;

    // garlands
    ctx.globalCompositeOperation = "lighter";
    ctx.lineWidth = 2;
    for(const g of garlands){
      const yy = cy + ((g.ny - 0.5) * 1.44) * scale;
      const ww = scale * g.amp;
      ctx.globalAlpha = 0.20 + 0.14*Math.sin(t*1.25 + g.phase);
      ctx.strokeStyle = "rgba(255,255,255,0.38)";
      ctx.beginPath();
      ctx.ellipse(cx, yy, ww, scale*0.10, 0, 0, Math.PI);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // tree particles
    for(const p of tree){
      const pulse = 0.55 + 0.45*Math.sin(t*2.2 + p.phase);
      const twi = p.tw*pulse;

      const wob = Math.sin(t*p.spd + p.phase) * 0.06;
      const x = p.nx*(1+wob);
      const y = (p.ny - 0.5) * 1.44; // correct orientation
      const z = p.nz*(1+wob);

      const pr = project(x,y,z, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const a = clamp((0.10 + twi)*pr.p, 0.06, 0.95);
      const r0 = (p.size*1.05) * (0.65 + pr.p);

      ctx.globalAlpha = a;
      ctx.fillStyle = p.c;
      ctx.beginPath(); ctx.arc(sx,sy,r0,0,Math.PI*2); ctx.fill();

      ctx.globalAlpha = a*0.26;
      ctx.beginPath(); ctx.arc(sx,sy,r0*3.2,0,Math.PI*2); ctx.fill();
    }

    // blinking lights (stronger glow)
    for(const l of lights){
      const blink = 0.45 + 0.55*Math.sin(t*l.spd + l.phase);
      const pr = project(l.nx, (l.ny-0.5)*1.44, l.nz, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const a = clamp(0.22 + 0.70*blink, 0.14, 0.98) * pr.p;
      const r0 = l.r*(0.9 + pr.p*0.35);

      ctx.globalAlpha = a;
      ctx.fillStyle = l.c;
      ctx.beginPath(); ctx.arc(sx,sy,r0,0,Math.PI*2); ctx.fill();

      ctx.globalAlpha = a*0.42;
      ctx.beginPath(); ctx.arc(sx,sy,r0*5.4,0,Math.PI*2); ctx.fill();
    }

    // ornaments
    for(const o of ornaments){
      const bob = Math.sin(t*2.2 + o.phase)*0.02;
      const pr = project(o.nx*(1+bob), (o.ny-0.5)*1.44, o.nz*(1+bob), rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const glow = 0.55 + 0.45*Math.sin(t*3.1 + o.phase);
      ctx.globalAlpha = 0.68*glow;

      ctx.fillStyle = o.c;
      ctx.beginPath(); ctx.arc(sx, sy, o.r*(0.78+pr.p*0.25), 0, Math.PI*2); ctx.fill();

      ctx.globalAlpha *= 0.45;
      ctx.fillStyle = "rgba(255,255,255,0.88)";
      ctx.beginPath(); ctx.arc(sx - o.r*0.25, sy - o.r*0.25, o.r*0.35, 0, Math.PI*2); ctx.fill();

      ctx.globalAlpha *= 0.60;
      ctx.fillStyle = o.c;
      ctx.beginPath(); ctx.arc(sx, sy, o.r*2.35, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;

    // base glow
    ctx.globalCompositeOperation = "lighter";
    const baseY = cy + scale*0.60;
    const base = ctx.createRadialGradient(cx, baseY, 0, cx, baseY, scale*0.52);
    base.addColorStop(0, `rgba(125,249,255,${0.10 + 0.03*Math.sin(t*1.1)})`);
    base.addColorStop(0.35, "rgba(255,239,154,0.07)");
    base.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = base;
    ctx.beginPath(); ctx.arc(cx, baseY, scale*0.52, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = "source-over";

    // gifts (canvas)
    for(const g of giftHotspots){
      drawGiftBox(cx, baseY, scale, g, 0.96);
    }

    // bursts
    ctx.globalCompositeOperation = "lighter";
    for(let i=bursts.length-1;i>=0;i--){
      const b = bursts[i];
      b.life -= 1;
      b.x += b.vx; b.y += b.vy;
      b.vx *= 0.985; b.vy *= 0.985;
      b.vy += 0.02;

      const a = Math.max(0, b.life/85);
      ctx.globalAlpha = a;
      ctx.fillStyle = b.c;
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      if(b.life<=0) bursts.splice(i,1);
    }
    ctx.globalAlpha = 1;
    ctx.globalCompositeOperation = "source-over";

    // update gift hotspots overlay position (align with gifts)
    for(let i=0;i<giftHotspots.length;i++){
      const g = giftHotspots[i];
      const el = hsEls[i];
      const x = cx + g.x*scale;
      const y = baseY + g.y*scale;
      el.style.left = x + "px";
      el.style.top  = y + "px";
    }

    requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);

})();
</script>
</body>
</html>
