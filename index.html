<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merry Christmas - Particle Tree</title>
  <style>
    :root{
      --bg:#050814;
      --fg:#eaf2ff;
      --gold:#ffef9a;
      --glow:#7df9ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; overflow:hidden; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    canvas{position:fixed; inset:0}

    /* top title */
    .top{
      position:fixed; top:16px; left:0; right:0;
      display:flex; justify-content:center; pointer-events:none;
      z-index:6;
      text-transform:uppercase;
      letter-spacing:2px;
      font-weight:900;
      color:rgba(255,239,154,.95);
      text-shadow:0 0 18px rgba(255,239,154,.25), 0 18px 40px rgba(0,0,0,.55);
    }
    .top span{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }

    /* hint */
    .hint{
      position:fixed; bottom:16px; left:16px;
      z-index:6;
      color:rgba(234,242,255,.82);
      font-size:13px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      user-select:none;
    }

    /* small cards (gallery) */
    .cards{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      display:flex;
      gap:22px;
      z-index:7;
      opacity:0;
      pointer-events:none;
      transition:opacity .55s ease, transform .55s ease;
    }
    .cards.show{
      opacity:1;
      pointer-events:auto;
      transform:translate(-50%,-50%) scale(1);
    }
    .card{
      width:92px; height:92px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid rgba(255,239,154,.75);
      background:rgba(255,255,255,.05);
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      cursor:pointer;
      position:relative;
      transform:translateY(6px);
      transition:transform .18s ease, filter .18s ease;
    }
    .card:hover{ transform:translateY(0); filter:drop-shadow(0 0 18px rgba(255,239,154,.25)); }
    .card img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* lightbox */
    .lightbox{
      position:fixed; inset:0;
      z-index:10;
      display:none;
      place-items:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .lightbox.show{ display:grid; }
    .viewer{
      width:min(520px, 92vw);
      aspect-ratio: 1/1;
      border-radius:18px;
      overflow:hidden;
      border:3px solid rgba(255,239,154,.75);
      box-shadow:0 40px 120px rgba(0,0,0,.6);
      background:#0b1230;
      position:relative;
      touch-action:none;
    }
    .viewer img{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%) scale(1);
      transform-origin:center;
      user-select:none;
      -webkit-user-drag:none;
      width:100%; height:100%;
      object-fit:cover;
    }
    .close{
      position:fixed; top:16px; right:16px; z-index:11;
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:var(--fg);
      font-weight:900;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .tools{
      position:fixed; bottom:16px; right:16px; z-index:11;
      display:flex; gap:10px;
    }
    .toolbtn{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:var(--fg);
      font-weight:900;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div class="top"><span>MERRY CHRISTMAS</span></div>
  <div class="hint">Click cây thông để chuyển cảnh • Click ảnh để phóng to • Zoom: lăn chuột / pinch</div>

  <div class="cards" id="cards">
    <div class="card" data-id="1"><img id="img1" alt="photo 1"></div>
    <div class="card" data-id="2"><img id="img2" alt="photo 2"></div>
  </div>

  <div class="lightbox" id="lightbox" aria-hidden="true">
    <button class="close" id="closeBtn">✕</button>
    <div class="viewer" id="viewer">
      <img id="bigImg" alt="big photo">
    </div>
    <div class="tools">
      <button class="toolbtn" id="zoomOut">−</button>
      <button class="toolbtn" id="zoomReset">Reset</button>
      <button class="toolbtn" id="zoomIn">+</button>
    </div>
  </div>

<script>
(() => {
  // ========= IMAGES (Bạn thay ảnh ở đây) =========
  // Cách thay: đổi URL ở dưới thành link ảnh của bạn (hoặc đặt ảnh vào thư mục assets rồi dùng "assets/tenanh.jpg")
  const PHOTO_1 = "https://images.unsplash.com/photo-1544785349-c4a5301826fd?auto=format&fit=crop&w=900&q=80";
  const PHOTO_2 = "https://images.unsplash.com/photo-1512389142860-9c449e58a543?auto=format&fit=crop&w=900&q=80";

  document.getElementById("img1").src = PHOTO_1;
  document.getElementById("img2").src = PHOTO_2;

  // ========= CANVAS / PARTICLES =========
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false });
  let w=0,h=0,dpr=1;

  function resize(){
    dpr = Math.min(2, devicePixelRatio || 1);
    w = canvas.width = Math.floor(innerWidth * dpr);
    h = canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + "px";
    canvas.style.height = innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  const rand=(a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  // States: "tree" -> "galaxy"
  let state = "tree";
  let transition = 0; // 0..1

  // palette like video (gold & warm particles)
  const cols = ["#ffef9a","#ffd166","#ff9f1c","#ff4d6d","#b388ff","#7df9ff","#a7ff83","#ffffff"];

  // Create TREE particles (cone + sparkle)
  const tree = [];
  const N_TREE = 1800;

  function initTree(){
    tree.length = 0;
    for(let i=0;i<N_TREE;i++){
      const t = i / (N_TREE-1);          // 0..1 bottom-ish
      const y = 1 - t;                   // top = 1
      const radius = (0.04 + 0.55*(1-y)) * (0.92 + 0.08*Math.sin(t*10));
      const turns = 14;
      const ang = t * Math.PI * 2 * turns + rand(-0.35,0.35);

      const nx = Math.cos(ang)*radius;
      const nz = Math.sin(ang)*radius;
      const ny = y;

      tree.push({
        nx, ny, nz,
        size: rand(0.6, 2.2),
        phase: rand(0, Math.PI*2),
        spd: rand(0.8, 1.9),
        c: cols[Math.floor(rand(0, cols.length))],
        tw: rand(0.35, 1.0),
        // will be used in galaxy mode
        gx: rand(-1,1),
        gy: rand(-1,1),
        gvx: rand(-0.25,0.25),
        gvy: rand(-0.25,0.25),
      });
    }
  }
  initTree();

  // simple projection (fake 3D)
  function project(x,y,z, rotY, rotX){
    const cy=Math.cos(rotY), sy=Math.sin(rotY);
    let xx = x*cy + z*sy;
    let zz = -x*sy + z*cy;

    const cx=Math.cos(rotX), sx=Math.sin(rotX);
    let yy = y*cx - zz*sx;
    zz = y*sx + zz*cx;

    const dist = 2.25;
    const p = dist / (dist + zz);
    return { x: xx*p, y: yy*p, p };
  }

  // mouse parallax rotation
  let mx=innerWidth/2, my=innerHeight/2;
  addEventListener('pointermove', e => { mx=e.clientX; my=e.clientY; }, {passive:true});

  // click to transition
  addEventListener('click', () => {
    if(state === "tree"){
      state = "galaxy";
    }
  });

  // Draw star
  function drawStar(cx, cy, R, r){
    ctx.beginPath();
    for(let i=0;i<10;i++){
      const a = -Math.PI/2 + i*(Math.PI/5);
      const rr = (i%2===0)?R:r;
      ctx.lineTo(cx + Math.cos(a)*rr, cy + Math.sin(a)*rr);
    }
    ctx.closePath();
    ctx.fill();
  }

  // ===== cards show after transition =====
  const cards = document.getElementById('cards');

  // ===== render loop =====
  let last = performance.now();
  function frame(now){
    const dt = Math.min(40, now-last); last=now;
    const t = now*0.001;

    // background
    ctx.fillStyle = "#050814";
    ctx.fillRect(0,0,innerWidth,innerHeight);

    // fade trail like video "sparkle smear"
    ctx.fillStyle = "rgba(0,0,0,0.12)";
    ctx.fillRect(0,0,innerWidth,innerHeight);

    // rotation from mouse
    const nx = (mx - innerWidth/2) / innerWidth;
    const ny = (my - innerHeight/2) / innerHeight;
    const rotY = nx*1.15 + Math.sin(t*0.25)*0.12;
    const rotX = -0.22 + ny*0.55;

    // transition easing if galaxy
    if(state === "galaxy"){
      transition = clamp(transition + dt/900, 0, 1);
      if(transition > 0.6) cards.classList.add("show");
    }else{
      transition = clamp(transition - dt/900, 0, 1);
      cards.classList.remove("show");
    }

    // center & scale
    const cx = innerWidth*0.5;
    const cy = innerHeight*0.55;
    const scale = Math.min(innerWidth, innerHeight)*0.55;

    // Star + title vibe (only strong in tree mode)
    const starY = cy - scale*0.57;
    const starGlow = (1-transition);
    if(starGlow > 0.02){
      ctx.globalCompositeOperation = "lighter";
      const rg = ctx.createRadialGradient(cx, starY, 0, cx, starY, scale*0.22);
      rg.addColorStop(0, `rgba(255,239,154,${0.55*starGlow})`);
      rg.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = rg;
      ctx.beginPath(); ctx.arc(cx, starY, scale*0.22, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = `rgba(255,239,154,${0.95*starGlow})`;
      drawStar(cx, starY, scale*0.06, scale*0.026);
      ctx.globalCompositeOperation = "source-over";
    }

    // particles
    ctx.globalCompositeOperation = "lighter";

    for(const p of tree){
      // wobble sparkle
      const pulse = 0.55 + 0.45*Math.sin(t*2.1 + p.phase);
      const tw = p.tw*pulse;

      // TREE position (cone)
      const wob = Math.sin(t*p.spd + p.phase) * 0.06;
      const tx = p.nx*(1+wob);
      const ty = (p.ny-0.5)*1.28;
      const tz = p.nz*(1+wob);

      // GALAXY position (2D swirl)
      p.gx += p.gvx*dt*0.001;
      p.gy += p.gvy*dt*0.001;
      // keep in soft bounds
      if(p.gx<-1||p.gx>1) p.gvx*=-1;
      if(p.gy<-1||p.gy>1) p.gvy*=-1;

      const swirl = Math.sin(t*0.7 + p.phase)*0.25;
      const gx = p.gx + Math.cos(t*0.35 + p.phase)*0.08;
      const gy = p.gy + Math.sin(t*0.35 + p.phase)*0.08;

      // mix tree -> galaxy
      const mix = transition;
      const x = tx*(1-mix) + gx*1.05*mix;
      const y = ty*(1-mix) + gy*0.85*mix;
      const z = tz*(1-mix) + swirl*mix;

      const pr = project(x,y,z, rotY, rotX);
      const sx = cx + pr.x*scale;
      const sy = cy + pr.y*scale;

      const a = clamp((0.10 + tw)*pr.p, 0.06, 0.95);
      const r0 = (p.size*1.05) * (0.65 + pr.p);

      // dot
      ctx.globalAlpha = a;
      ctx.fillStyle = p.c;
      ctx.beginPath(); ctx.arc(sx, sy, r0, 0, Math.PI*2); ctx.fill();

      // soft glow
      ctx.globalAlpha = a*0.28;
      ctx.beginPath(); ctx.arc(sx, sy, r0*3.1, 0, Math.PI*2); ctx.fill();
    }

    // base glow
    ctx.globalAlpha = 0.55;
    const bg = ctx.createRadialGradient(cx, cy+scale*0.52, 0, cx, cy+scale*0.52, scale*0.44);
    bg.addColorStop(0, `rgba(125,249,255,${0.10*(1-transition)+0.07})`);
    bg.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = bg;
    ctx.beginPath(); ctx.arc(cx, cy+scale*0.52, scale*0.44, 0, Math.PI*2); ctx.fill();

    ctx.globalAlpha = 1;
    ctx.globalCompositeOperation = "source-over";
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  // ========= LIGHTBOX + ZOOM (mouse wheel / pinch) =========
  const lightbox = document.getElementById("lightbox");
  const bigImg = document.getElementById("bigImg");
  const viewer = document.getElementById("viewer");

  let zoom = 1, panX = 0, panY = 0;
  let dragging=false, sx0=0, sy0=0, px0=0, py0=0;
  let pinch=false, pinchDist0=0, zoom0=1;

  function applyTransform(){
    bigImg.style.transform = `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${zoom})`;
  }
  function openImg(src){
    bigImg.src = src;
    zoom = 1; panX = 0; panY = 0;
    applyTransform();
    lightbox.classList.add("show");
    lightbox.setAttribute("aria-hidden","false");
  }
  function closeImg(){
    lightbox.classList.remove("show");
    lightbox.setAttribute("aria-hidden","true");
  }

  cards.addEventListener("click", (e)=>{
    const card = e.target.closest(".card");
    if(!card) return;
    const id = card.getAttribute("data-id");
    openImg(id==="1" ? PHOTO_1 : PHOTO_2);
  });

  document.getElementById("closeBtn").addEventListener("click", closeImg);
  lightbox.addEventListener("click", (e)=>{ if(e.target === lightbox) closeImg(); });

  // Buttons
  document.getElementById("zoomIn").addEventListener("click", ()=>{ zoom = clamp(zoom*1.15, 1, 4); applyTransform(); });
  document.getElementById("zoomOut").addEventListener("click", ()=>{ zoom = clamp(zoom/1.15, 1, 4); applyTransform(); });
  document.getElementById("zoomReset").addEventListener("click", ()=>{ zoom=1; panX=0; panY=0; applyTransform(); });

  // Mouse wheel zoom
  viewer.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const dir = Math.sign(e.deltaY);
    const factor = dir > 0 ? 0.92 : 1.08;
    zoom = clamp(zoom*factor, 1, 4);
    applyTransform();
  }, {passive:false});

  // Drag to pan
  viewer.addEventListener("pointerdown", (e)=>{
    viewer.setPointerCapture(e.pointerId);
    dragging = true;
    sx0 = e.clientX; sy0 = e.clientY;
    px0 = panX; py0 = panY;
  });
  viewer.addEventListener("pointermove", (e)=>{
    if(!dragging || pinch) return;
    panX = px0 + (e.clientX - sx0);
    panY = py0 + (e.clientY - sy0);
    applyTransform();
  });
  viewer.addEventListener("pointerup", ()=>{ dragging=false; });

  // Touch pinch (2 fingers) using Pointer Events
  const pointers = new Map();
  viewer.addEventListener("pointerdown", (e)=>{ pointers.set(e.pointerId, e); if(pointers.size===2){ pinch=true; initPinch(); } });
  viewer.addEventListener("pointermove", (e)=>{
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, e);
    if(pointers.size===2){
      doPinch();
    }
  });
  viewer.addEventListener("pointerup", (e)=>{ pointers.delete(e.pointerId); if(pointers.size<2){ pinch=false; } });
  viewer.addEventListener("pointercancel", (e)=>{ pointers.delete(e.pointerId); if(pointers.size<2){ pinch=false; } });

  function dist(a,b){
    const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
    return Math.hypot(dx,dy);
  }
  function initPinch(){
    const [a,b] = [...pointers.values()];
    pinchDist0 = dist(a,b);
    zoom0 = zoom;
  }
  function doPinch(){
    const [a,b] = [...pointers.values()];
    const d = dist(a,b);
    const ratio = d / (pinchDist0 || d);
    zoom = clamp(zoom0 * ratio, 1, 4);
    applyTransform();
  }

})();
</script>
</body>
</html>
